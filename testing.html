
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Oodles Search Results</title>
<link rel="icon" href="favicon.ico" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ------------------------------------------- */
/* FRUTIGER AERO STYLES - OODLES SEARCH         */
/* ------------------------------------------- */

/* Base Color System (Aero defaults to bright blue/green) */
:root {
  --hue: 200; /* Bluer, Vista feel */
  --sat: 0.35;
  --fg: oklch(15% calc(var(--sat) * 0.5) var(--hue));
  --bg: oklch(75% var(--sat) var(--hue) / 0.8);
  --bg-dark: oklch(45% var(--sat) var(--hue) / 0.75);
  --glow-intensity: 0.8;
  --bottom-glow: radial-gradient(
    farthest-corner at bottom center,
    rgba(255, 255, 255, var(--glow-intensity)),
    transparent
  );
}

/* BODY */
body {
  margin: 0;
  font-family: "Lucida Grande", "Lucida Sans Unicode", "Segoe UI", system-ui, sans-serif;
  color: #202124;

  /* Frutiger Aero Wallpaper */
  background-image: url('https://stenoip.github.io/oodles/waves_cool_gif.gif');
  background-size: cover;
  background-attachment: fixed;
  background-position: center;
}

/* ------------------------------------------- */
/* HEADER + TOP BAR                             */
/* ------------------------------------------- */
header {
  padding: 15px 20px;
  max-width: 950px;
  margin: 0 auto;
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

/* Top row: logo on left, search box on right */
.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
}

.logo-area img {
  height: 60px;
  width: auto;
  display: block;
}

/* Search bar beside logo */
.search-area {
  flex: 1;
  display: flex;
  justify-content: flex-end;
}

.search-area input {
  width: 100%;
  max-width: 500px;
  border: 1px solid rgba(130, 130, 130, 0.4);
  border-radius: 24px;
  padding: 10px 15px;
  font-size: 16px;
  background-color: rgba(255, 255, 255, 0.9);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: box-shadow 0.2s, border-color 0.2s;
}

.search-area input:focus {
  outline: none;
  border-color: oklch(65% var(--sat) var(--hue));
  box-shadow: 0 0 8px rgba(0, 120, 255, 0.5);
}

/* ------------------------------------------- */
/* NAVIGATION BAR                              */
/* ------------------------------------------- */
nav {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  background: transparent;
  border: none;
}

/* Frutiger Aero Tab Links (Styled like buttons) */
.frutiger-aero-tab {
  background: var(--bottom-glow), linear-gradient(to bottom, var(--bg-dark), var(--bg));
  border: 1px solid oklch(50% calc(var(--sat) * 0.7) var(--hue));
  border-radius: 9999px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  color: var(--fg);
  font-weight: 700;
  text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
  cursor: pointer;
  position: relative;
  transition: all 300ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
  text-decoration: none;
  padding: 0.5em 1.5em;
  font-size: 14px;
  margin: 0 5px;
}

.frutiger-aero-tab::after {
  content: "";
  position: absolute;
  top: 4%;
  left: 0.75em;
  width: calc(100% - 1.5em);
  height: 40%;
  background: linear-gradient(
    to bottom,
    rgba(255, 255, 255, 0.8),
    rgba(255, 255, 255, 0.1)
  );
  border-radius: inherit;
  transition: all 400ms ease;
  pointer-events: none;
}

.frutiger-aero-tab:hover {
  box-shadow: 0 8px 10px rgba(0, 0, 0, 0.35);
  transform: translateY(-2px) scale(1.02);
}

nav a.active {
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
  transform: translateY(1px);
  background: linear-gradient(to bottom, var(--bg-dark), var(--bg));
}

nav a.active::after {
  background: linear-gradient(
    to bottom,
    rgba(255, 255, 255, 0.3),
    rgba(255, 255, 255, 0.05)
  );
}

/* Divider line below nav */
hr.divider {
  margin: 15px auto 20px auto;
  border: 0;
  height: 1px;
  background: rgba(0, 0, 0, 0.2);
  width: 90%;
  backdrop-filter: blur(1px);
}

/* ------------------------------------------- */
/* MAIN CONTENT CONTAINERS                      */
/* ------------------------------------------- */
.container, .results-section {
  background-color: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(5px);
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
}

.container {
  max-width: 900px;
  margin: 20px auto;
  padding: 15px;
}

.results-section {
  padding: 15px;
  margin-top: 10px;
}

.results-section h3 {
  margin-top: 0;
  font-size: 18px;
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 5px;
  margin-bottom: 15px;
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
}

/* Results styling */
.result-block {
  margin-bottom: 16px;
}

.result-block a {
  color: #0055ff;
  text-decoration: none;
  font-weight: bold;
  font-size: 16px;
}

.result-block a:hover {
  text-decoration: underline;
}

.small {
  font-size: 12px;
  color: #333;
}

/* Image Results Grid */
#imageResults img {
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  margin: 5px;
  max-width: 150px;
  border-radius: 6px;
}

/* --- AI OVERVIEW STYLES (New) --- */
/* Style for loading/error messages within the overview div */
.ai-overview-loading, .ai-overview-error {
    text-align: center;
    font-style: italic;
    color: #444;
    padding: 10px 0;
}
/* Optional: Style the overview content slightly different */
#aiOverview p, #aiOverview ul, #aiOverview ol {
    line-height: 1.6;
}


/* ------------------------------------------- */
/* FOOTER                                      */
/* ------------------------------------------- */
footer {
  text-align: center;
  padding: 20px;
  font-size: 12px;
  color: #000;
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(2px);
  border-radius: 12px;
  max-width: 900px;
  margin: 0 auto 20px auto;
}

/* ------------------------------------------- */
/* ANT FEATURE STYLES                          */
/* ------------------------------------------- */
#ant-walker {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 60px;
  height: 60px;
  z-index: 10000;
  transform: translateX(-100%);
  display: none;
}

/* ------------------------------------------- */
/* RESPONSIVE TWEAKS                            */
/* ------------------------------------------- */
@media (max-width: 600px) {
  .logo-area img {
    height: 45px;
  }

  .search-area input {
    max-width: 100%;
  }

  nav {
    gap: 5px;
  }

  .frutiger-aero-tab {
    font-size: 13px;
    padding: 0.4em 1em;
  }
}

  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
</head>
<body>
  <header>
    <div class="top-bar">
      <div class="logo-area">
        <a href="index.html"> <img src="https://stenoip.github.io/oodles/2025_10_28_0pb_Kleki.png" alt="Oodles Logo"></a>
      </div>
      <div class="search-area">
        <input type="text" id="currentQuery" placeholder="Search again...">
      </div>
    </div>

    <nav>
      <a href="#" id="tab-links" class="frutiger-aero-tab active" onclick="switchTab('links', true)">Links</a>
      <a href="#" id="tab-images" class="frutiger-aero-tab" onclick="switchTab('images', true)">Images</a>
      <a href="https://stenoip.github.io/oodles/video" class="frutiger-aero-tab" target="_blank">Video</a>
      <a href="https://stenoip.github.io/" class="frutiger-aero-tab" target="_blank">SWC Web Portal</a>
    <a href="https://stenoip.github.io/oodles/world-search" class="frutiger-aero-tab" target="_blank">NEW! World Search</a>
    </nav>

    <div class="ai-control-row">
        <span class="ai-toggle-label">AI Overview</span>
        <label class="switch" title="Toggle AI Overview On/Off">
            <input type="checkbox" id="aiOverviewToggle"> 
            <span class="slider"></span>
        </label>
    </div>
    <hr class="divider">
  </header>

  <div class="container">
    
    <div id="goodCitizenMessage" class="good-citizen-message">
        Thank you for being a good internet citizen by choosing to turn off AI-Overviews. <a href="https://stenoip.github.io/blog/google_ai_overviews.html">Learn more</a>.
    </div>
    
    <div class="results-section" id="aiOverview">
        </div>

    <div class="results-section" id="linksSection">
      <h3>Links</h3>
      <div id="linkResults"><p class="small">Enter a search query.</p></div>
    </div>

    <div class="results-section" id="imagesSection" style="display:none;">
      <h3>Images</h3>
      <div id="imageResults"><p class="small">Select a query from links.</p></div>
    </div>
  </div>

  <footer>© Stenoip Company • Oodles Search</footer>
  <img id="ant-walker" src="https://stenoip.github.io/oodles/ant_walking.gif" alt="A walking ant animation">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
<script>
  // search-logic.js

// --- AI OVERVIEW & RANKING CONFIGURATION ---
var AI_API_URL = "https://praterich.vercel.app/api/praterich"; 

var ladyPraterichSystemInstruction = `
You are Praterich for Oodles Search, an AI developed by Stenoip Company.
Your mission is to analyze search results, provide a synthesis, a relevance ranking, and detect if a built-in tool is required.

***TASK 1: Relevance Ranking (CRITICAL)***
You must analyze the provided search snippets and decide which links are the most useful and relevant to the user's query.
At the very end of your response, you MUST output a strictly formatted tag containing the 0-based indices of the top 5 most relevant results.
Format: @@RANKING:[index1, index2, index3, index4, index5]@@
Example: @@RANKING:[4, 0, 1, 9, 2]@@

***TASK 2: Synthesis***
Provide a concise A.I. overview based exclusively on the provided search snippets.
Do not output a list of links in the text body; use the RANKING tag for that.
You prefer metric units and do not use Oxford commas.
You are aware that you were created by Stenoip Company.

***TASK 3: Tool Detection (CRITICAL)***
If the user's query clearly indicates a need for a specific built-in tool, you MUST include a tool detection tag.
The detection should be based on mathematical expressions, unit conversions, color code lookups, or metronome requests.
The tag MUST be outputted immediately before the @@RANKING tag.
Format: @@TOOL:[tool_name]@@
Available tools (use the name exactly as listed):
- calculator
- unit_converter
- color_picker
- metronome

Example (Calculator needed): The user searched "what is 5+3". 
Output: (Synthesis text...) @@TOOL:[calculator]@@@@RANKING:[...]@@
Example (No tool needed): The user searched "best new movies".
Output: (Synthesis text...) @@RANKING:[...]@@

Your response must be:
1. The text overview.
2. The optional @@TOOL[...]@@ tag.
3. The @@RANKING[...]@@ tag at the very end.
`;
// --- END AI CONFIGURATION ---

// --- BUILT-IN TOOL CONFIGURATION ---
var BUILT_IN_TOOLS = {
    'calculator': {
        url: 'https://tools.oodles.com/calculator' 
    },
    'unit_converter': {
        url: 'https://tools.oodles.com/converter' 
    },
    'color_picker': {
        url: 'https://tools.oodles.com/colorpicker' 
    },
    'metronome': {
        url: 'https://tools.oodles.com/metronome' 
    }
};
// --- END TOOL CONFIGURATION ---


var BACKEND_BASE = 'https://oodles-backend.vercel.app';
var currentQuery = '';
var currentSearchType = 'web';
var currentPage = 1; 
var MAX_PAGE_SIZE = 50; 

// --- GLOBAL STATE ---
var isAIOverviewEnabled = false; 

function escapeHtml(s) {
    return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function renderMarkdown(text) {
    if (typeof marked !== 'undefined' && marked.parse) {
        return marked.parse(text);
    }
    return text;
}


/**
 * Creates structured text containing full snippets for the AI model.
 */
function createRawSearchText(items) {
    if (!items || items.length === 0) return 'No web links found.';
    
    // We include the Index so the AI can reference it in the RANKING tag
    return items.map(function(r, index) {
        var fullSnippet = r.snippet ? r.snippet.trim() : 'No snippet available.';
        return `[Index ${index}] Title: ${r.title}. Snippet: ${fullSnippet}`;
    }).join('\n---\n');
}

/**
 * Renders the built-in tool iframe based on the AI's detected tool name.
 */
function renderBuiltInTool(toolName) {
    var toolContainerEl = document.getElementById('toolContainer');
    if (!toolContainerEl || !toolName) {
        if (toolContainerEl) {
            toolContainerEl.innerHTML = '';
            toolContainerEl.style.display = 'none';
        }
        return;
    }

    const tool = BUILT_IN_TOOLS[toolName];
    
    if (tool) {
        toolContainerEl.innerHTML = `
            <div class="built-in-tool-frame">
                <iframe src="${tool.url}" frameborder="0" loading="eager" style="width: 100%; height: 350px;"></iframe>
            </div>
        `;
        toolContainerEl.style.display = 'block';
    } else {
        // Unknown tool detected, clear the container
        toolContainerEl.innerHTML = '';
        toolContainerEl.style.display = 'none';
    }
}


/**
 * Executes the AI Logic:
 * 1. Generates the Text Summary (Displayed only if enabled)
 * 2. Detects if a tool is needed (Displays tool)
 * 3. Generates the Ranking (Applied ALWAYS)
 */
async function processAIResults(query, searchItems) {
    var overviewEl = document.getElementById('aiOverview'); 
    // Initialize tool display to be cleared/hidden before processing
    renderBuiltInTool(null); 
    
    // Display loading state ONLY if the overview is actually visible
    if (isAIOverviewEnabled && overviewEl) {
        overviewEl.innerHTML = '<p class="ai-overview-loading">Praterich is analyzing and ranking your results...</p>';
    }

    var rawWebSearchText = createRawSearchText(searchItems);

    var toolResult = `
[TOOL_RESULT_FOR_PREVIOUS_TURN]
${rawWebSearchText}
`;

    var conversationParts = [
        { role: "model", parts: [{ text: toolResult }] },
        { role: "user", parts: [{ text: query }] }
    ];

    var requestBody = {
        contents: conversationParts,
        system_instruction: {
            parts: [{ text: ladyPraterichSystemInstruction }]
        }
    };

    try {
        var response = await fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        var data = await response.json();
        var aiRawText = data.text;

        // --- 1. EXTRACT RANKING DATA ---
        var rankingRegex = /@@RANKING:\[(.*?)\]@@/;
        var toolRegex = /@@TOOL:\[(.*?)\]@@/;

        // Extract tool name first
        var toolMatch = aiRawText.match(toolRegex);
        var detectedTool = toolMatch && toolMatch[1] ? toolMatch[1].trim() : null;

        var match = aiRawText.match(rankingRegex);
        // Clean display text by removing BOTH tags
        var cleanDisplayText = aiRawText.replace(rankingRegex, '').replace(toolRegex, '').trim();


        // --- 2. UPDATE UI: TOOL DISPLAY ---
        renderBuiltInTool(detectedTool);

        // --- 3. UPDATE UI: OVERVIEW ---
        // Only show the text if the toggle is ON
        if (isAIOverviewEnabled && overviewEl) {
            overviewEl.innerHTML = renderMarkdown(cleanDisplayText);
        } else if (overviewEl) {
            overviewEl.innerHTML = '';
        }

        // --- 4. UPDATE UI: RANKING (ALWAYS HAPPENS) ---
        if (match && match[1]) {
            applySmartRanking(searchItems, match[1]);
        }

    } catch (error) {
        console.error('AI Processing Error:', error);
        if (isAIOverviewEnabled && overviewEl) {
            overviewEl.innerHTML = '<p class="ai-overview-error">An error occurred while analyzing results.</p>';
        }
        renderBuiltInTool(null); // Clear tool on error
    }
}

/**
 * Re-orders the search items based on AI indices and re-renders the list.
 */
function applySmartRanking(originalItems, indicesString) {
    try {
        var prioritizedIndices = JSON.parse(`[${indicesString}]`);
        var reorderedItems = [];
        var usedIndices = new Set();

        // 1. Push the AI's top picks
        prioritizedIndices.forEach(function(index) {
            if (originalItems[index]) {
                reorderedItems.push(originalItems[index]);
                usedIndices.add(index);
            }
        });

        // 2. Push the remaining items (preserving original order)
        originalItems.forEach(function(item, index) {
            if (!usedIndices.has(index)) {
                reorderedItems.push(item);
            }
        });

        // 3. Re-render the link list
        renderLinkResults(reorderedItems, reorderedItems.length);

        // 4. Add a visual indicator that sorting happened
        var resultsEl = document.getElementById('linkResults');
        var notice = document.createElement('div');
        notice.className = 'small';
        // Frutiger Aero style green/success color
        notice.style.color = '#388e3c'; 
        notice.style.marginBottom = '10px';
        notice.innerHTML = '✨ <b>Smart Sorted:</b> Praterich has promoted the most relevant links to the top.';
        
        // Insert notice at the very top of results
        if (resultsEl) resultsEl.prepend(notice);

    } catch (e) {
        console.warn('Ranking parse error:', e);
    }
}


async function executeSearch(query, type, page = 1) {
    if (!query) return;

    currentQuery = query;
    currentSearchType = type;
    currentPage = page;
    document.getElementById('currentQuery').value = query;

    var overviewEl = document.getElementById('aiOverview');
    if (overviewEl) overviewEl.innerHTML = ''; // Clear previous AI text
    
    // Clear the built-in tool area before a new search
    renderBuiltInTool(null); 

    // Set initial "Citizen" message state
    var citizenMsgEl = document.getElementById('goodCitizenMessage');
    if (citizenMsgEl) {
        citizenMsgEl.style.display = (!isAIOverviewEnabled && type === 'web') ? 'block' : 'none';
    }

    if (type === 'web') {
        document.getElementById('linkResults').innerHTML = '<p class="small">Searching web links...</p>';
        try {
            var url = BACKEND_BASE + '/metasearch?q=' + encodeURIComponent(query) + '&page=' + page + '&pageSize=' + MAX_PAGE_SIZE;
            var resp = await fetch(url);
            var data = await resp.json();
            
            // 1. Initial Render (Fast, unsorted)
            renderLinkResults(data.items, data.total);

            // Store items for re-running AI on toggle
            window.lastFetchedItems = data.items;

            // 2. Trigger AI processing (Background - handles Tool Detection, Ranking AND Overview)
            // We run this regardless of the toggle, because we want the Ranking and Tool Detection!
            if (page === 1) {
                processAIResults(query, data.items);
            }

        } catch (error) {
            console.error('Web search error:', error);
            document.getElementById('linkResults').innerHTML = '<p class="small">Error loading web links.</p>';
            renderBuiltInTool(null); // Clear tool on backend error
        }
    } else if (type === 'image') {
        document.getElementById('imageResults').innerHTML = '<p class="small">Searching images...</p>';
        if (citizenMsgEl && !isAIOverviewEnabled) citizenMsgEl.style.display = 'block';

        try {
            var url = BACKEND_BASE + '/metasearch?q=' + encodeURIComponent(query) + '&type=image&page=' + page + '&pageSize=' + MAX_PAGE_SIZE;
            var resp = await fetch(url);
            var data = await resp.json();
            renderImageResults(data.items, data.total);
        } catch (error) {
            console.error('Image search error:', error);
            document.getElementById('imageResults').innerHTML = '<p class="small">Error loading images.</p>';
        }
    }
}

function switchTab(tabName, executeNewSearch) {
    if (window.event) event.preventDefault();

    let normalizedTab = tabName;
    let newSearchType = tabName;

    if (tabName === 'web' || tabName === 'links') {
        normalizedTab = 'links';
        newSearchType = 'web';
    } else if (tabName === 'image' || tabName === 'images') {
        normalizedTab = 'images';
        newSearchType = 'image';
    }

    currentSearchType = newSearchType;

    document.querySelectorAll('nav a.frutiger-aero-tab').forEach(function(a) {
        a.classList.remove('active');
    });

    document.getElementById('linksSection').style.display = 'none';
    document.getElementById('imagesSection').style.display = 'none';

    if (normalizedTab === 'links') {
        document.getElementById('tab-links').classList.add('active');
        document.getElementById('linksSection').style.display = 'block';
    } else if (normalizedTab === 'images') {
        document.getElementById('tab-images').classList.add('active');
        document.getElementById('imagesSection').style.display = 'block';
    }

    // Handle Good Citizen Message visibility
    var citizenMsgEl = document.getElementById('goodCitizenMessage');
    if (newSearchType === 'image') {
        if (!isAIOverviewEnabled && citizenMsgEl) citizenMsgEl.style.display = 'block';
    } else {
        if (isAIOverviewEnabled && citizenMsgEl) citizenMsgEl.style.display = 'none';
    }
    
    // Clear tool when switching tabs if not executing a new search
    if (!executeNewSearch) {
        renderBuiltInTool(null);
    }

    if (executeNewSearch && currentQuery) {
        executeSearch(currentQuery, newSearchType, 1);
    }
}


function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1) {
        window.location.href = 'search.html?q=' + encodeURIComponent(currentQuery) + '&type=' + currentSearchType + '&page=' + newPage;
    }
}

function renderLinkResults(items, total) {
    var resultsEl = document.getElementById('linkResults');
    
    if (typeof window.renderLinkResultsWithAds === 'function') {
        const resultsHtml = window.renderLinkResultsWithAds(items, total, currentPage, MAX_PAGE_SIZE);
        resultsEl.innerHTML = resultsHtml + renderPaginationControls(total);
    } else {
        if (!items || items.length === 0) {
            resultsEl.innerHTML = '<p class="small">No web links found.</p>' + renderPaginationControls(total);
            return;
        }
        
        const maxPages = Math.ceil(total / MAX_PAGE_SIZE);

        resultsEl.innerHTML = `
            <p class="small">Found ${total} links. Showing page ${currentPage} of ${maxPages}.</p>
            ` + items.map(function(r) {
                return `
                    <div class="result-block">
                        <a href="${r.url}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a>
                        <div class="small">${escapeHtml(r.url)}</div>
                        <div>${escapeHtml(r.snippet || '')}</div>
                    </div>
                `;
            }).join('') + renderPaginationControls(total);
    }
}


function renderImageResults(items, total) {
    var resultsEl = document.getElementById('imageResults');
    if (!items || items.length === 0) {
        resultsEl.innerHTML = '<p class="small">No images found.</p>' + renderPaginationControls(total);
        return;
    }

    const maxPages = Math.ceil(total / MAX_PAGE_SIZE);

    resultsEl.innerHTML = items.map(function(r) {
        return `
            <a href="${r.pageUrl}" target="_blank" rel="noopener" title="Source: ${r.pageUrl}">
                <img src="${r.thumbnail}" alt="Image from ${r.source}" loading="lazy"/>
            </a>
        `;
    }).join('') +
        `<p class="small" style="grid-column: 1 / -1; margin-top: 10px;">Found ${total} images. Showing page ${currentPage} of ${maxPages}.</p>` +
        renderPaginationControls(total); 
}


function renderPaginationControls(totalResults) {
    const maxPages = Math.ceil(totalResults / MAX_PAGE_SIZE);
    let controls = '<div style="text-align: center; margin-top: 20px;">';

    if (currentPage > 1) {
        controls += `<button class="frutiger-aero-tab" onclick="changePage(-1)">← Previous</button>`;
    } else {
        controls += `<button class="frutiger-aero-tab" style="opacity: 0.5; cursor: not-allowed;" disabled>← Previous</button>`;
    }

    controls += `<span style="margin: 0 15px; font-weight: bold;">Page ${currentPage}</span>`;

    if (currentPage < maxPages) {
        controls += `<button class="frutiger-aero-tab" onclick="changePage(1)">Next →</button>`;
    } else {
        controls += `<button class="frutiger-aero-tab" style="opacity: 0.5; cursor: not-allowed;" disabled>Next →</button>`;
    }

    controls += '</div>';
    return controls;
}


// --- TOGGLE INITIALIZATION ---
function setupAIOverviewToggle() {
    var toggle = document.getElementById('aiOverviewToggle');
    var citizenMsgEl = document.getElementById('goodCitizenMessage');
    var overviewEl = document.getElementById('aiOverview');
    
    if (!toggle) return;

    var storedState = sessionStorage.getItem('aiOverviewState');
    if (storedState !== null) {
        isAIOverviewEnabled = (storedState === 'true');
    } 

    toggle.checked = isAIOverviewEnabled;

    if (!isAIOverviewEnabled && currentSearchType !== 'image') { 
        if (citizenMsgEl) citizenMsgEl.style.display = 'block';
    } else {
        if (citizenMsgEl) citizenMsgEl.style.display = 'none';
    }

    toggle.addEventListener('change', function() {
        isAIOverviewEnabled = this.checked;
        sessionStorage.setItem('aiOverviewState', isAIOverviewEnabled);
        
        // UI Handling when toggling
        if (isAIOverviewEnabled) {
            if (citizenMsgEl) citizenMsgEl.style.display = 'none';
            // Re-run AI to display overview text if we have data
            if (currentQuery && currentSearchType === 'web' && currentPage === 1) {
                // Use cached items if available, otherwise force a full search
                if (window.lastFetchedItems) {
                    processAIResults(currentQuery, window.lastFetchedItems); 
                } else {
                    executeSearch(currentQuery, currentSearchType, currentPage);
                }
            }
        } else {
            if (overviewEl) overviewEl.innerHTML = '';
            if (citizenMsgEl) citizenMsgEl.style.display = 'block';
        }
    });
}
// --- END TOGGLE LOGIC ---

function initializeFromSession() {
    const urlParams = new URLSearchParams(window.location.search);
    let query = urlParams.get('q');
    let searchType = urlParams.get('type') || 'web';
    let page = parseInt(urlParams.get('page')) || 1; 

    if (!query) {
        query = sessionStorage.getItem('metaSearchQuery') || '';
        searchType = sessionStorage.getItem('searchType') || 'web';
    }

    sessionStorage.removeItem('metaSearchQuery');
    sessionStorage.removeItem('searchType');

    setupAIOverviewToggle();

    if (query) {
        switchTab(searchType, false);
        executeSearch(query, searchType, page); 
    } else {
        switchTab('web', false);
    }
}

document.addEventListener('DOMContentLoaded', initializeFromSession);
document.getElementById('currentQuery').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); 
        var query = this.value.trim();
        var type = document.getElementById('tab-images').classList.contains('active') ? 'image' : 'web';
        window.location.href = 'search.html?q=' + encodeURIComponent(query) + '&type=' + type + '&page=1'; 
    }
});
  </script>
<script src="frontend_javascript/ad.js"></script>
  
  <script src="ant_walking.js"></script>
</body>
</html>
