<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MetaSearch Results</title>
    <link rel="icon" href="2025_09_13_0vp_Kleki.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { background-color: #c0c0c0; font-family: "Courier New", Courier, monospace; color: #000080; margin: 0; }
        header { background-color: #000080; text-align: center; padding: 20px; border-bottom: 3px double #fff; }
        header img { max-height: 120px; }
        .container { padding: 20px; max-width: 980px; margin: 0 auto; }
                .result-block { margin-bottom: 12px; border-bottom: 1px dotted #808080; padding-bottom: 8px; }
        .result-block a { color: #000080; font-weight: bold; text-decoration: none; }
        .result-block a:hover { text-decoration: underline; }
                .small { font-size: 12px; color: #333; }
        .score { color: #555; font-size: 12px; }
                /* Search bar styling */
        #searchBox { padding: 10px; margin-bottom: 20px; background-color: #e0e0e0; border: 2px groove #808080; display: flex; align-items: center; }
        #searchBox input[type="text"] { flex-grow: 1; padding: 8px; font-size: 16px; border: 2px inset #808080; background-color: #fff; margin-right: 10px; font-family: "Courier New", Courier, monospace; }
        #searchBox button { padding: 8px 16px; font-size: 14px; background-color: #000080; color: white; border: 2px outset #fff; cursor: pointer; }
        /* Images section grid */
        #imageResults {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        #imageResults a {
            display: block;
            line-height: 0; /* remove gap under image */
        }
        #imageResults img {
            width: 100%;
            height: auto;
            border: 2px solid #000080;
            display: block;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://stenoip.github.io/oodles/2025_09_13_0vp_Kleki.png" alt="Oodles Logo">
    </header>
    <div class="container">
        <div id="searchBox">
            <input type="text" id="currentQuery" placeholder="Search again...">
            <button onclick="reRunSearch()">Search</button>
        </div>
                        <h2>Search Results for: <span id="queryDisplay"></span></h2>
        <h3 id="linksHeader">Links</h3>
        <div id="linkResults">
            </div>
        <h3 id="imagesHeader">Images</h3>
        <div id="imageResults">
            </div>
        <div class="pagination" id="metaPager" style="display:none;">
            <button onclick="alert('Pagination not yet implemented in search.html.')">Prev</button>
            <span id="metaPageInfo">Page 1 of ?</span>
            <button onclick="alert('Pagination not yet implemented in search.html.')">Next</button>
        </div>
    </div>
    <script>
        var BACKEND_BASE = 'https://oodles-backend.vercel.app';

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // Function to run a new search from the results page (always defaults to web search for simplicity)
        function reRunSearch() {
            const newQuery = document.getElementById('currentQuery').value.trim();
            if (newQuery) {
                // Set the query and default the type to 'web' for re-run
                sessionStorage.setItem('metaSearchQuery', newQuery);
                sessionStorage.setItem('searchType', 'web');
                window.location.reload(); // Reload the current page to trigger the new search
            }
        }

        // Function to render Web Link results
        function renderLinkResults(items, total) {
            const resultsEl = document.getElementById('linkResults');

            if (!items || items.length === 0) {
                resultsEl.innerHTML = '<p class="small">No web links found.</p>';
                return;
            }

            resultsEl.innerHTML = `
                <p class="small">Found ${total} links.</p>
                ${items.map(r => `
                    <div class="result-block">
                        <a href="${r.url}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a>
                        <div class="small">${escapeHtml(r.url)}</div>
                        <div>${escapeHtml(r.snippet || '')}</div>
                        <div class="score">Source: ${r.source} â€¢ Score: ${r.score.toFixed(2)}</div>
                    </div>
                `).join('')}
            `;
        }

        // Function to render Image results
        function renderImageResults(items) {
            const resultsEl = document.getElementById('imageResults');

            if (!items || items.length === 0) {
                resultsEl.innerHTML = '<p class="small">No images found.</p>';
                return;
            }

            // Render images as links to their hosting pages
            resultsEl.innerHTML = `
                ${items.map(r => `
                    <a href="${r.pageUrl}" target="_blank" rel="noopener">
                        <img src="${r.thumbnail}" alt="Image from ${r.source}" loading="lazy"/>
                    </a>
                `).join('')}
                <p class="small" style="grid-column: 1 / -1; margin-top: 10px;">Found ${items.length} images.</p>
            `;
        }

        async function displayResults() {
            // Get search parameters from sessionStorage
            const query = sessionStorage.getItem('metaSearchQuery') || '';
            const searchType = sessionStorage.getItem('searchType') || 'web';

            // Clear session storage immediately after reading
            sessionStorage.removeItem('metaSearchQuery');
            sessionStorage.removeItem('searchType');

            document.getElementById('queryDisplay').textContent = query;
            document.getElementById('currentQuery').value = query;

            if (!query) {
                document.getElementById('linkResults').innerHTML = '<h3>No query found.</h3><p>Please return to the main page to search again.</p>';
                return;
            }

            const isImageSearch = searchType === 'image';

            // Set initial state: hide the section that is NOT being searched
            document.getElementById('linksHeader').style.display = isImageSearch ? 'none' : 'block';
            document.getElementById('imagesHeader').style.display = isImageSearch ? 'block' : 'none';
            document.getElementById('linkResults').innerHTML = isImageSearch ? '' : '<p class="small">Searching web links...</p>';
            document.getElementById('imageResults').innerHTML = isImageSearch ? '<p class="small">Searching images...</p>' : '';

            // --- 1. Fetch Web Links (ONLY if searchType is 'web') ---
            if (!isImageSearch) {
                try {
                    // This URL remains the same (assumed path to serverless function)
                    const url = `${BACKEND_BASE}/metasearch?q=${encodeURIComponent(query)}&page=1&pageSize=20`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    renderLinkResults(data.items, data.total);
                } catch (e) {
                    document.getElementById('linkResults').innerHTML = '<p class="small">Error loading web links. Please try again.</p>';
                }
            }

            // --- 2. Fetch Images (ONLY if searchType is 'image') ---
            if (isImageSearch) {
                try {
                    // CORRECTED: Use the same /metasearch path with the new '&type=image' query parameter
                    const url = `${BACKEND_BASE}/metasearch?q=${encodeURIComponent(query)}&type=image`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    renderImageResults(data.items);
                } catch (e) {
                    document.getElementById('imageResults').innerHTML = '<p class="small">Error loading images. Please try again.</p>';
                }
            }
        }

        // Run the display function when the page loads
        document.addEventListener('DOMContentLoaded', displayResults);
    </script>
</body>
</html>
